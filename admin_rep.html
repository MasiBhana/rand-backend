<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rand C&C – Rep Orders</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 10px;
    }
    button {
      padding: 6px 10px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th,
    td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 13px;
      vertical-align: top;
    }
    th {
      background: #eee;
    }
    .small {
      font-size: 11px;
      color: #555;
    }
    .filters {
      margin-bottom: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    input[type="text"],
    input[type="password"] {
      padding: 4px;
      font-size: 12px;
    }
    .login-box {
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Rand C&C – Rep Orders</h1>
  <div class="small">
    <a href="/admin">Admin Orders</a> |
    <a href="/admin/products-page">Products</a> |
    <strong>Rep View</strong>
  </div>

  <!-- LOGIN PANEL -->
  <div id="loginBox" class="login-box">
    <div class="small"><strong>Rep login</strong></div>
    <label class="small">
      Phone:
      <input type="text" id="loginPhone" placeholder="e.g. 1111" />
    </label>
    <label class="small">
      Password:
      <input type="password" id="loginPassword" placeholder="rep password" />
    </label>
    <button onclick="login()">Login</button>
    <span id="loginStatus" class="small"></span>
  </div>

  <!-- MAIN CONTENT -->
  <div id="mainContent" class="hidden">
    <div class="filters">
      <span id="repInfo" class="small"></span>
      <button onclick="loadRepOrders()">Refresh my orders</button>
      <span id="status" class="small"></span>
    </div>

    <table id="ordersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer</th>
          <th>Status</th>
          <th>Total</th>
          <th>Created</th>
          <th>Items</th>
          <th>Location</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let authToken = null;
    let currentUser = null;

    async function login() {
      const phone = document.getElementById('loginPhone').value.trim();
      const password = document
        .getElementById('loginPassword')
        .value.trim();
      const loginStatus = document.getElementById('loginStatus');

      if (!phone || !password) {
        loginStatus.textContent = ' Please enter phone and password.';
        return;
      }

      loginStatus.textContent = ' Logging in...';

      try {
        const res = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, password })
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.message || 'Login failed');
        }

        if (data.user.role !== 'rep' && data.user.role !== 'admin') {
          loginStatus.textContent =
            ' Access denied: rep or admin only.';
          return;
        }

        authToken = data.token;
        currentUser = data.user;
        loginStatus.textContent =
          ' Logged in as ' +
          currentUser.name +
          ' (' +
          currentUser.role +
          ').';

        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');

        document.getElementById('repInfo').textContent =
          'Showing orders for phone: ' + currentUser.phone;

        loadRepOrders();
      } catch (e) {
        console.error(e);
        loginStatus.textContent = ' Error: ' + e.message;
      }
    }

    async function loadRepOrders() {
      const statusEl = document.getElementById('status');
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      statusEl.textContent = '';

      if (!authToken || !currentUser) {
        statusEl.textContent = ' Not logged in.';
        return;
      }

      try {
        statusEl.textContent = ' Loading...';

        const res = await fetch('/orders', {
          headers: { 'x-auth-token': authToken }
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.message || 'Failed to load orders');
        }

        const filtered = data.filter(
          (o) => o.user && String(o.user.phone) === String(currentUser.phone)
        );

        if (filtered.length === 0) {
          statusEl.textContent =
            ' No orders found for phone ' + currentUser.phone + '.';
          return;
        }

        statusEl.textContent =
          ' Showing ' +
          filtered.length +
          ' order(s) for phone ' +
          currentUser.phone +
          '.';

        filtered
          .slice()
          .sort((a, b) => b.id - a.id)
          .forEach((order) => {
            const tr = document.createElement('tr');

            const itemsHtml = (order.items || [])
              .map(
                (it) =>
                  `${it.qty} x ${it.name} (R${it.price}) = R${it.lineTotal.toFixed(
                    2
                  )}`
              )
              .join('<br>');

            const locText = order.location
              ? `Lat: ${
                  order.location.latitude?.toFixed?.(5) ??
                  order.location.latitude
                }, Lng: ${
                  order.location.longitude?.toFixed?.(5) ??
                  order.location.longitude
                }`
              : 'No location';

            tr.innerHTML = `
              <td>${order.id}</td>
              <td>${order.customerName || ''}</td>
              <td>${order.status}</td>
              <td>R ${order.total.toFixed(2)}</td>
              <td class="small">${new Date(order.createdAt).toLocaleString()}</td>
              <td class="small">${itemsHtml}</td>
              <td class="small">${locText}</td>
              <td class="small">${order.note || ''}</td>
            `;

            tbody.appendChild(tr);
          });
      } catch (e) {
        console.error(e);
        statusEl.textContent = ' Error loading orders: ' + e.message;
      }
    }
  </script>
</body>
</html>
